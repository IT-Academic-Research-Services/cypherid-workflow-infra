# Testing

The test suite for this component uses [moto](https://github.com/spulec/moto) and [Step Functions
Local](https://docs.aws.amazon.com/step-functions/latest/dg/sfn-local.html) to run tests against local mock servers.
To run the test suite, first run the following at the root of this directory:

```
# Launch the mock servers
scripts/local.sh

make deploy-mock

```

You can run all tests with `make test` or run a single test with:
```
# Only run tests in test/test_utils.py
make test-one path="test.test_utils"

# Only run the test_success test in test/test_utils.py
make test-one path="test.test_utils.TestUtils.test_success"
```

## Overview of test execution

A pipeline step test requires both an IDseq dag JSON file, as well as the mock input files for the pipeline step.

When a test is executed, the IDseq dag JSON is first translated to WDL. miniWDL then receives the WDL file and the paths to your mock input files, and executes the pipeline step as specified. Afterwards, miniWDL returns information about where it placed each of the output files generated by the pipeline step. If the pipeline step failed, miniWDL will return information about the error.

Whenever a test is run, miniWDL will generate a directory with various files related to the execution of your test. The name of the directory will be something like `20200424_144955_idseq_test`.

Some files you may find helpful:
- Inside the `wdl/` folder, there will be `.wdl` that contains the generated WDL for your test.
- Inside the `call-XX` folder (where `XX` is related to the name of your test):
  - `stderr.txt` will contain anything that was sent to stderr during your test's execution.
  - The `work/` folder will contain the output files that were generated by your test.

## Tips for  of writing tests

See `test_utils.py` for some basic tests that also demonstrate the usage of the utility functions in `utils.py`.

The utility functions in `utils.py` will handle translating to WDL, executing with miniWDL, and parsing the miniWDL response on your behalf, including parsing any error messages.

Create a new directory for each new pipeline step that you plan to test. You will place the input files and IDseq dag JSON files into this directory along with your test file.

One things to be aware of is how miniWDL renames the files you specify in your dag JSON.

For example, if one of the targets in your dag JSON is named:
```
"targets": {
    "test_in": [
        "input_R1.fa"
    ]
}
```

WDL will expect an input named `test_in_input_R1_fa`. You will see more examples of this in the example tests.

## Caveats

A special exception to WDL renaming is if your target is called `fastq`. If your target is like this:

```
"targets": {
    "fastqs": [
        "input_R1.fa",
        "input_R2.fa",
    ]
}
```

you might expect your inputs to be named `fastqs_input_R1_fa` and `fastqs_input_R2_fa`. However, the inputs will be named `fastqs_0` and `fastqs_1` in this particular case.

Also, if you have a target named `fastq`, then a `max_fragments` parameter is required in your dag JSON:

```
"given_targets": {
    "fastqs": {
        "s3_dir": "s3://",
        "max_fragments": 75000000
    }
}
```
